name: AI Agent

on:
  issues:
    types:
      - labeled

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-task:
    if: github.event.label.name == 'ai-task'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Aider
        run: pip install aider-chat
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create Branch
        run: |
          BRANCH="ai-fix-${{ github.event.issue.number }}"
          git checkout -b $BRANCH
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV
      
      - name: Run Aider
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROMPT="${{ github.event.issue.title }}

${{ github.event.issue.body }}"
          
          echo "$PROMPT" | aider --yes --model claude-3-5-sonnet-20241022 bot.py
      
      - name: Commit and Push
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "no_changes=true" >> $GITHUB_ENV
          else
            git commit -m "ðŸ¤– AI: ${{ github.event.issue.title }}"
            git push -u origin ${{ env.BRANCH_NAME }}
            echo "no_changes=false" >> $GITHUB_ENV
          fi
      
      - name: Create Pull Request
        if: env.no_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ¤– AI: ${{ github.event.issue.title }}" \
            --body "Automated fix for #${{ github.event.issue.number }}

Generated by AI Agent using Claude Sonnet 4.5

**Review checklist:**
- [ ] Code follows project style
- [ ] No breaking changes
- [ ] Ready to merge

Closes #${{ github.event.issue.number }}" \
            --base main \
            --head ${{ env.BRANCH_NAME }}
