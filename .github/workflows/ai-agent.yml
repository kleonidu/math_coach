name: AI Agent

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-task:
    if: github.event.label.name == 'ai-task'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Aider
        run: pip install aider-chat
      
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Create Branch
        run: |
          BRANCH="ai-fix-${{ github.event.issue.number }}"
          git checkout -b $BRANCH
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV
      
      - name: Run Aider
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > task.txt << 'TASK_EOF'
          ${{ github.event.issue.title }}
          
          ${{ github.event.issue.body }}
          TASK_EOF
          
          aider --yes --model claude-3-5-sonnet-20241022 --message "$(cat task.txt)" bot.py
      
      - name: Push Changes
        id: push
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git add -A
            git commit -m "AI: ${{ github.event.issue.title }}"
            git push origin ${{ env.BRANCH_NAME }}
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create PR
        if: steps.push.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "AI: ${{ github.event.issue.title }}" --body "Fixes #${{ github.event.issue.number }}" --base main --head ${{ env.BRANCH_NAME }}
