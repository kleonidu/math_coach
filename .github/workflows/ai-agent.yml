name: AI Agent

on:
  issues:
    types: [opened, labeled]

jobs:
  ai-develop:
    if: contains(github.event.issue.labels.*.name, 'ai-task')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Aider
        run: pip install aider-chat
      
      - name: Configure Git
        run: |
          git config --global user.name "AI Agent"
          git config --global user.email "ai@github.com"
      
      - name: Create branch
        run: |
          BRANCH="ai-task-${{ github.event.issue.number }}"
          git checkout -b $BRANCH
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV
      
      - name: Run Aider
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          TASK="${{ github.event.issue.title }}"
          BODY="${{ github.event.issue.body }}"
          
          echo "Task: $TASK" > prompt.txt
          echo "" >> prompt.txt
          echo "$BODY" >> prompt.txt
          
          aider --yes --model claude-3-5-sonnet-20241022 --message "$(cat prompt.txt)" bot.py
      
      - name: Push changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "AI: ${{ github.event.issue.title }}"
            git push origin ${{ env.BRANCH_NAME }}
          fi
      
      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ü§ñ AI: ${{ github.event.issue.title }}" \
            --body "Auto-generated by AI Agent. Closes #${{ github.event.issue.number }}" \
            --base main \
            --head ${{ env.BRANCH_NAME }} || echo "PR already exists"
      
      - name: Comment on success
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "‚úÖ AI Agent created a Pull Request!"
      
      - name: Comment on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "‚ùå AI Agent failed. Check workflow logs."
